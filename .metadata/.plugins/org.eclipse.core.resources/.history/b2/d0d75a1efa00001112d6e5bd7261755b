<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Checkout | Razorpay</title>

    <!-- Razorpay SDK (MANDATORY) -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <!-- Bootstrap (optional) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-5">
    <div class="card shadow p-4">
        <h3 class="text-center mb-4">Checkout</h3>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label>Name</label>
                <input type="text" id="name" class="form-control" required>
            </div>

            <div class="col-md-6 mb-3">
                <label>Phone</label>
                <input type="text" id="phone" class="form-control" required>
            </div>

            <div class="col-md-6 mb-3">
                <label>Password</label>
                <input type="password" id="password" class="form-control" required>
            </div>

            <div class="col-md-6 mb-3">
                <label>House No</label>
                <input type="text" id="house" class="form-control" required>
            </div>

            <div class="col-md-6 mb-3">
                <label>City</label>
                <input type="text" id="city" class="form-control" required>
            </div>

            <div class="col-md-6 mb-3">
                <label>State</label>
                <input type="text" id="state" class="form-control" required>
            </div>

            <div class="col-md-6 mb-3">
                <label>Zipcode</label>
                <input type="text" id="zipcode" class="form-control" required>
            </div>
        </div>

        <!-- IMPORTANT: type="button" -->
        <button type="button" class="btn btn-primary w-100 mt-3" onclick="placeOrder()">
            Pay Now
        </button>
    </div>
</div>

<script>
function placeOrder() {

    fetch("/place-Order", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            name: document.getElementById("name").value,
            password: document.getElementById("password").value,
            phoneno: document.getElementById("phone").value,
            shippingAddress: {
                houseno: document.getElementById("house").value,
                city: document.getElementById("city").value,
                state: document.getElementById("state").value,
                country: "India",
                zipcode: document.getElementById("zipcode").value
            }
        })
    })
    .then(res => res.json())
    .then(order => {
        console.log("Order created:", order);
        openRazorpay(order);   // ðŸ”¥ OPEN POPUP
    })
    .catch(err => {
        alert("Order creation failed");
        console.error(err);
    });
}

function openRazorpay(order) {

    var options = {
        key: "rzp_test_SBA3kqiat8sYVm",   // ðŸ”‘ YOUR RAZORPAY KEY_ID
        amount: order.totalPrice * 100, // paise
        currency: "INR",
        name: "MyShop",
        description: "Order Payment",
        order_id: order.razorpayOrderId,

        handler: function (response) {
            verifyPayment(response);
        },

        prefill: {
            name: document.getElementById("name").value,
            contact: document.getElementById("phone").value
        },

        theme: {
            color: "#0d6efd"
        }
    };

    var rzp = new Razorpay(options);
    rzp.open();   // ðŸš€ POPUP OPENS HERE
}

function verifyPayment(response) {

    fetch("http://localhost:3333/order/payment-verify", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            razorPayOrderId: response.razorpay_order_id,
            razorPayPaymentId: response.razorpay_payment_id,
            razorPaySignature: response.razorpay_signature
        })
    })
    .then(res => res.text())
    .then(msg => {
        alert("Payment Successful!");
        window.location.href = "/order-success";
    })
    .catch(err => {
        alert("Payment verification failed");
        console.error(err);
    });
}
</script>

</body>
</html>
